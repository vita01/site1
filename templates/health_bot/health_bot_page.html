{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="min-h-screen flex items-center justify-center bg-white dark:bg-black">
  <div class="max-w-2xl w-full mx-auto p-6 bg-gray-50 dark:bg-gray-900 rounded-2xl shadow">
    <h1 class="text-2xl font-bold mb-4 text-green-700">ü§ñ –ó–¥–æ—Ä–æ–≤—ã–π –±–æ—Ç</h1>
    <p class="mb-4 text-gray-600 dark:text-gray-300">
      –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –∏ –ø–∏—Ç–∞–Ω–∏—é, –∏ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç!
    </p>

    <textarea id="question" rows="4" class="w-full p-3 border rounded" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å..."></textarea>
    <button onclick="askBot()" class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">
      –û—Ç–ø—Ä–∞–≤–∏—Ç—å
    </button>

    <div id="answer" class="mt-6 p-4 bg-green-100 text-green-900 rounded hidden"></div>

    <button id="save-btn" onclick="saveAdvice()" 
    class="mt-4 w-full bg-white border border-green-600 text-green-700 py-2 rounded-lg font-semibold hover:bg-green-100 transition hidden">
    üíæ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–≤–µ—Ç –Ω–∞ —Å–∞–π—Ç
  </button>
  <a href="{% url 'advice_list' %}" class="block mt-4 text-green-600 underline">üìñ –°–º–æ—Ç—Ä–µ—Ç—å —Å–æ–≤–µ—Ç—ã</a>

  </div>
</section>

<script>
  // –ü–æ–ª—É—á–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫–∏
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –±–æ—Ç—É
  async function askBot() {
  const question = document.getElementById("question").value.trim();
  const answerBox = document.getElementById("answer");
  const saveBtn = document.getElementById("save-btn");
  answerBox.classList.add("hidden");
  saveBtn.classList.add("hidden");

  if (!question) return;

  answerBox.innerText = "‚è≥ –î—É–º–∞—é...";
  answerBox.classList.remove("hidden");

  try {
    const response = await fetch("/api/ask_bot/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ question }),  // ‚úÖ –í–û–¢ –¢–ê–ö
    });

    const data = await response.json();
    answerBox.innerText = data.answer || data.error || "‚ö†Ô∏è –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫";

    if (data.answer) {
      saveBtn.classList.remove("hidden");
    }
  } catch (e) {
    answerBox.innerText = "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
  }
}

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–≤–µ—Ç–∞
  async function saveAdvice() {
    const text = document.getElementById("answer").innerText;

    if (!text) return;

    try {
      const response = await fetch("/api/save_advice/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ text }),
      });

      const data = await response.json();

      if (data.status === "ok") {
        alert("‚úÖ –°–æ–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–∞–π—Ç!");
        document.getElementById("save-btn").classList.add("hidden");
      } else {
        alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
      }
    } catch (e) {
      alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
    }
  }
</script>
{% endblock %}
